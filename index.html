<!DOCTYPE html>
<html lang="es">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ventas ASADITOS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #10b981;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #6b7280;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: white;
            padding: 10px;
            gap: 10px;
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            background: #10b981;
            color: white;
        }

        .content {
            display: none;
            padding: 20px;
        }

        .content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #1f2937;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #374151;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #10b981;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:active {
            background: #059669;
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .product-card {
            background: #f9fafb;
            border: 3px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .product-card.selected {
            border-color: #10b981;
            background: #d1fae5;
        }

        .product-card:active {
            transform: scale(0.95);
        }

        .product-name {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .product-price {
            color: #10b981;
            font-size: 18px;
            font-weight: 700;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #10b981;
            color: white;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
        }

        .quantity-btn:active {
            background: #059669;
        }

        .quantity {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            min-width: 30px;
            text-align: center;
        }

        .cliente-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cliente-info h3 {
            color: #1f2937;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .cliente-info p {
            color: #6b7280;
            font-size: 14px;
        }

        .deuda {
            color: #ef4444;
            font-weight: 700;
            font-size: 16px;
        }

        .deuda.positiva {
            color: #10b981;
        }

        .venta-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .venta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .venta-cliente {
            font-weight: 700;
            color: #1f2937;
            font-size: 16px;
        }

        .venta-total {
            color: #10b981;
            font-weight: 700;
            font-size: 18px;
        }

        .venta-fecha {
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .venta-productos {
            font-size: 14px;
            color: #4b5563;
        }

        .metodo-pago {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .metodo-efectivo {
            background: #d1fae5;
            color: #065f46;
        }

        .metodo-transferencia {
            background: #dbeafe;
            color: #1e40af;
        }

        .metodo-tarjeta-debito, .metodo-tarjeta-credito {
            background: #e0e7ff;
            color: #3730a3;
        }

        .metodo-credito {
            background: #fef3c7;
            color: #92400e;
        }

        .metodo-deuda {
            background: #fee2e2;
            color: #991b1b;
        }

        .total-venta {
            background: #10b981;
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            margin: 20px 0;
            position: sticky;
            top: 70px;
            z-index: 50;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .total-flotante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .total-flotante:active {
            transform: scale(0.95);
        }

        .total-flotante-expandido {
            bottom: 20px;
            right: 20px;
            left: 20px;
            border-radius: 16px;
            padding: 20px;
        }

        .total-detalle {
            display: grid;
            gap: 8px;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 600;
        }

        .total-detalle-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        #carritoDetalle {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    
        /* --- FIX: asegurar que el bot√≥n BIN sea clickeable en m√≥viles --- */
        #binConfigBtn{
            position: relative;
            z-index: 1001;
            pointer-events: auto;
            touch-action: manipulation;
        }
        .header{
            position: relative;
            z-index: 200;
        }


        /* ===== MESAS ===== */
        .actions-row{
            display:flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .actions-row .btn{
            flex: 1 1 220px;
        }
        .mesa-active-bar{
            background: #111827;
            color: #fff;
            padding: 12px 14px;
            border-radius: 14px;
            margin-bottom: 14px;
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,.12);
        }
        .mesa-active-bar .left{
            display:flex;
            flex-direction: column;
            gap: 2px;
        }
        .mesa-active-bar .title{
            font-weight: 800;
            font-size: 16px;
        }
        .mesa-active-bar .subtitle{
            font-size: 12px;
            opacity: .85;
        }
        .mesa-active-bar .right{
            display:flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content:flex-end;
        }
        .mesas-grid{
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }
        .mesa-card{
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 12px;
            background: #fff;
            cursor: pointer;
            transition: transform .08s ease, box-shadow .08s ease;
            user-select:none;
        }
        .mesa-card:hover{
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(0,0,0,.08);
        }
        .mesa-card .mesa-top{
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }
        .mesa-card .mesa-name{
            font-weight: 800;
        }
        .mesa-badge{
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #f3f4f6;
        }
        .mesa-badge.ocupada{
            background:#dcfce7;
        }
        .mesa-badge.libre{
            background:#f3f4f6;
        }
        .mesa-card .mesa-total{
            font-size: 18px;
            font-weight: 900;
            color:#10b981;
        }
        .mesa-card .mesa-info{
            font-size: 12px;
            opacity: .8;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üçñ Ventas ASADITOS</h1>
        <p id="currentDate"></p>
        <p id="syncStatus" style="font-size: 12px; margin-top: 5px; font-weight: 600;">Iniciando...</p>
        <button id="binConfigBtn" onclick="openBinSettings()" style="margin-top:8px; padding:8px 12px; border:none; border-radius:8px; background:#10b981; color:white; font-weight:700; cursor:pointer;">‚öôÔ∏è BIN</button>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('nueva-venta', this)">üí∞ Venta</button>
        <button class="tab" onclick="switchTab('productos', this)">üçñ Productos</button>
        <button class="tab" onclick="switchTab('clientes', this)">üë• Clientes</button>
        <button class="tab" onclick="switchTab('mesas', this)">ü™ë Mesas</button>
        <button class="tab" onclick="switchTab('cierre', this)">üíµ Cierre</button>
        <button class="tab" onclick="switchTab('historial', this)">üìä Historial</button>
    </div>

    <!-- NUEVA VENTA -->
    <div id="nueva-venta" class="content active">
        
        <div id="mesaActivaBar" class="mesa-active-bar" style="display:none;"></div>
<div class="total-venta" id="totalVenta">Total: 0 Gs</div>

        <div class="card">
            <h2>üë§ Seleccionar Cliente</h2>
            <div class="form-group">
                <select id="clienteSelect" onchange="selectCliente()">
                    <option value="">-- Seleccionar Cliente --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ü™ë Mesa (opcional)</label>
                <div style="display:flex; gap: 10px; align-items: center;">
                    <select id="mesaSelect" onchange="onMesaSelectChange()">
                        <option value="">Sin mesa (cobro directo)</option>
                    </select>
                    <button class="btn btn-secondary" type="button" onclick="switchTab('mesas', this)" style="white-space:nowrap;">Ver Mesas</button>
                </div>
                <div style="font-size:12px; opacity:0.75; margin-top:6px;">
                    Tip: us√° ‚ÄúGuardar en Mesa‚Äù para dejar pendiente. Para cobrar una mesa pendiente, entr√° en ‚ÄúMesas‚Äù y abrila.
                </div>
            </div>
<button class="btn btn-secondary" onclick="switchTab('clientes', this)">+ Agregar Nuevo Cliente</button>
        </div>

        <div class="card">
            <h2>üçñ Productos</h2>
            <div class="product-grid" id="productGrid"></div>
        </div>

        <div class="card" id="carritoDetalle" style="display: none;">
            <h2>üõí Detalle de la Venta</h2>
            <div id="listaCarrito" style="display: grid; gap: 10px;"></div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb; display: flex; justify-content: space-between; font-size: 18px; font-weight: 700;">
                <span>Subtotal:</span>
                <span id="subtotalCarrito" style="color: #10b981;">0 Gs</span>
            </div>
        </div>

        <div class="card">
            <h2>üí≥ M√©todo de Pago</h2>
            <div class="form-group">
                <select id="metodoPago" onchange="toggleVueltoCalculator()">
                    <option value="efectivo">üíµ Efectivo</option>
                    <option value="credito">üí≥ Cr√©dito (Pedidos Ya)</option>
                    <option value="transferencia">üè¶ Transferencia</option>
                    <option value="tarjeta-debito">üí≥ Tarjeta D√©bito</option>
                    <option value="tarjeta-credito">üí≥ Tarjeta Cr√©dito</option>
                    <option value="deuda">üìù Fiado (Deuda)</option>
                </select>
            </div>

            <!-- Calculadora de Vuelto (solo para efectivo) -->
            <div id="vueltoCalculator" style="display: none; margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 12px;">
                <h3 style="color: #10b981; margin-bottom: 15px; font-size: 16px;">üíµ Calcular Vuelto</h3>
                <div class="form-group">
                    <label>Cliente paga (Gs) <span style="color:#6b7280; font-weight:600;">(opcional)</span></label>
                    <input type="number" id="montoPagado" placeholder="Opcional" style="font-size: 20px; font-weight: 700;" oninput="calcularVuelto()">
                </div>
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Vuelto</div>
                    <div id="vueltoTotal" style="font-size: 32px; font-weight: 700;">0 Gs</div>
                </div>
            </div>
        </div>

                <div class="actions-row">
            <button class="btn btn-primary" id="registrarVentaBtn" onclick="registrarVenta()">‚úÖ Registrar Venta</button>
            <button class="btn btn-secondary" id="guardarMesaBtn" onclick="guardarEnMesa()" disabled>ü™ë Guardar en Mesa</button>
        </div>
    </div>


    <!-- MESAS -->
    <div id="mesas" class="content">
        <div class="card">
            <h2>ü™ë Mesas</h2>

            <div class="form-group">
                <label>Cantidad de mesas</label>
                <div style="display:flex; gap: 10px; align-items:center;">
                    <input type="number" id="mesasCount" min="1" max="50" value="12" style="max-width:120px;">
                    <button class="btn btn-secondary" type="button" onclick="aplicarMesasCount()">Aplicar</button>
                </div>
                <div style="font-size:12px; opacity:0.75; margin-top:6px;">
                    Toque una mesa para abrirla. Si est√° libre, pod√©s empezar un pedido pendiente. Si est√° ocupada, pod√©s agregar productos y luego cobrar.
                </div>
            </div>

            <div id="mesasGrid" class="mesas-grid"></div>
        </div>
    </div>    <!-- PRODUCTOS -->
    <div id="productos" class="content">
        <div class="card">
            <h2>‚ûï Nuevo Producto</h2>
            <div class="form-group">
                <label>Nombre del Producto</label>
                <input type="text" id="productoNombre" placeholder="Ej: ASADITO CARNE">
            </div>
            <div class="form-group">
                <label>Precio de Venta (Gs)</label>
                <input type="number" id="productoPrecio" placeholder="5000">
            </div>
            <button class="btn btn-primary" onclick="agregarProducto()">üíæ Guardar Producto</button>
        </div>

        <div class="card">
            <h2>üìã Lista de Productos <span class="badge badge-success" id="totalProductos">0</span></h2>
            <div id="listaProductos"></div>
        </div>
    </div>

    <!-- CIERRE DE CAJA -->
    <div id="cierre" class="content">
        <div class="card">
            <h2>üíµ Conteo de Efectivo</h2>

            <div style="display: grid; gap: 10px; margin-top: 12px; padding: 12px; background: #0f172a; border-radius: 10px; color: white;">
                <div style="display:flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <div style="font-weight:700;">üí∞ Sencillo del d√≠a (base de caja)</div>
                    <div style="display:flex; gap: 8px; align-items:center; flex-wrap: wrap;">
                        <input type="number" id="sencilloDiaInput" placeholder="Ej: 50000" style="width: 160px; padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.1); color: white; font-weight: 700;">
                        <button class="btn btn-secondary" onclick="guardarSencilloDia()">Guardar</button>
                    </div>
                </div>
                <div style="font-size: 13px; opacity: 0.9;">
                    Este monto se usa para calcular el efectivo esperado del d√≠a (sencillo + ventas efectivo - gastos en efectivo).
                </div>
            </div>

            
            <h3 style="color: #10b981; margin: 20px 0 10px 0; font-size: 16px;">üíµ Billetes</h3>
            <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">100.000 Gs</span>
                    <input type="number" id="billete100000" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total100000" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">50.000 Gs</span>
                    <input type="number" id="billete50000" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total50000" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">20.000 Gs</span>
                    <input type="number" id="billete20000" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total20000" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">10.000 Gs</span>
                    <input type="number" id="billete10000" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total10000" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">5.000 Gs</span>
                    <input type="number" id="billete5000" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total5000" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">2.000 Gs</span>
                    <input type="number" id="billete2000" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total2000" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
            </div>

            <h3 style="color: #10b981; margin: 20px 0 10px 0; font-size: 16px;">ü™ô Monedas</h3>
            <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">1.000 Gs</span>
                    <input type="number" id="moneda1000" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total1000" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">500 Gs</span>
                    <input type="number" id="moneda500" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total500" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">100 Gs</span>
                    <input type="number" id="moneda100" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total100" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <span style="font-weight: 600;">50 Gs</span>
                    <input type="number" id="moneda50" value="0" min="0" style="width: 80px; padding: 8px;" onchange="calcularCierre()">
                    <span id="total50" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
            </div>

            <div style="background: #10b981; color: white; padding: 20px; border-radius: 12px; margin-top: 20px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Efectivo Contado</div>
                <div id="totalEfectivoContado" style="font-size: 32px; font-weight: 700;">0 Gs</div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Resumen del D√≠a</h2>
            <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <span style="font-weight: 600;">üíµ Efectivo (Sistema)</span>
                    <span id="efectivoSistema" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <span style="font-weight: 600;">üè¶ Transferencias</span>
                    <span id="transferencias" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <span style="font-weight: 600;">üí∞ Sencillo del d√≠a</span>
                    <span id="sencilloDiaResumen" style="color: #10b981; font-weight: 800;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <span style="font-weight: 600;">üßæ Gastos efectivo (hoy)</span>
                    <span id="gastosEfectivoResumen" style="color: #ef4444; font-weight: 800;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #ecfeff; border-radius: 8px;">
                    <span style="font-weight: 700;">üéØ Efectivo esperado</span>
                    <span id="efectivoEsperadoResumen" style="color: #0f766e; font-weight: 900;">0 Gs</span>
                </div>

                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <span style="font-weight: 600;">üí≥ Tarjetas</span>
                    <span id="tarjetas" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <span style="font-weight: 600;">üí≥ Cr√©dito (Pedidos Ya)</span>
                    <span id="credito" style="color: #10b981; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                    <span style="font-weight: 600;">üìù Fiado</span>
                    <span id="fiado" style="color: #ef4444; font-weight: 700;">0 Gs</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 16px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 8px; font-size: 18px;">
                    <span style="font-weight: 700;">üí∞ TOTAL DEL D√çA</span>
                    <span id="totalDia" style="font-weight: 700;">0 Gs</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>‚öñÔ∏è Descuadre</h2>
            <div id="descuadreCard" style="padding: 20px; border-radius: 12px; text-align: center; font-size: 24px; font-weight: 700;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">Diferencia</div>
                <div id="descuadre">0 Gs</div>
                <div id="descuadreMensaje" style="font-size: 14px; margin-top: 10px; font-weight: 600;"></div>
            </div>
        </div>

        
        <div class="card">
            <h2>üßæ Gastos del D√≠a</h2>

            <div class="form-group">
                <label>Descripci√≥n</label>
                <input type="text" id="gastoDesc" placeholder="Ej: Carb√≥n, hielo, condimentos...">
            </div>

            <div class="form-group">
                <label>Monto (Gs)</label>
                <input type="number" id="gastoMonto" placeholder="Ej: 20000">
            </div>

            <div class="form-group">
                <label>Pagado con</label>
                <select id="gastoMetodo">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta</option>
                </select>
            </div>

            <button class="btn btn-secondary" onclick="agregarGasto()">‚ûï Agregar Gasto</button>

            <div style="margin-top: 14px; display:flex; justify-content: space-between; align-items:center; padding: 12px; background:#f9fafb; border-radius: 10px;">
                <span style="font-weight: 700;">Total gastos en efectivo (hoy)</span>
                <span id="totalGastosEfectivoHoy" style="font-weight: 800; color:#ef4444;">0 Gs</span>
            </div>

            <div id="gastosHoyLista" style="margin-top: 12px;"></div>
        </div>

<button class="btn btn-primary" onclick="guardarCierre()">üíæ Guardar Cierre del D√≠a</button>
    </div>

    <!-- CLIENTES -->
    <div id="clientes" class="content">
        <div class="card">
            <h2>‚ûï Nuevo Cliente</h2>
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="clienteNombre" placeholder="Ej: Juan P√©rez">
            </div>
            <div class="form-group">
                <label>Tel√©fono (opcional)</label>
                <input type="tel" id="clienteTelefono" placeholder="Ej: 0981123456">
            </div>
            <button class="btn btn-primary" onclick="agregarCliente()">üíæ Guardar Cliente</button>
        </div>

        <div class="card">
            <h2>üìã Lista de Clientes <span class="badge badge-success" id="totalClientes">0</span></h2>
            <div id="listaClientes"></div>
        </div>
    </div>

    <!-- HISTORIAL -->
    <div id="historial" class="content">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalVentasHoy">0</div>
                <div class="stat-label">Ventas Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ingresoHoy">0 Gs</div>
                <div class="stat-label">Ingreso Hoy</div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Ventas Recientes</h2>
            <div id="listaVentas"></div>
        </div>

        <div class="card">
            <h2>üíæ Backup Manual</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
                Descarga una copia de seguridad de todos tus datos
            </p>
            <button class="btn btn-secondary" onclick="exportarDatos()">üì• Descargar Backup</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="margin-top: 10px;">üì§ Restaurar Backup</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDatos(event)">
        </div>
    </div>

    <script>
        // Base de datos
        const DB = {
            clientes: [],
            ventas: [],
            productos: [],
            cierres: [],
            gastos: [],
            mesas: {}, // pedidos pendientes por mesa
            config: { sencilloDia: 0, mesasCount: 12 },
            _meta: { updatedAt: 0 }
        };

        
        // ===== CONFIGURACI√ìN BIN (JSONBin) =====
        // üîí IMPORTANTE:
        // - No pegues tu key en el c√≥digo del repo (se filtra).
        // - Esta configuraci√≥n se guarda SOLO en este dispositivo (localStorage).
        // - Recomendado: usar Access Key para apps en navegador.
        const BIN_DEFAULTS = {
            binId: '',               // ej: "69586b5c43b1c97be9155d82"
            header: 'X-Access-Key',  // o 'X-Master-Key'
            key: ''                  // Access Key o Master Key
        };

        function getBinConfig() {
            try {
                const saved = JSON.parse(localStorage.getItem('asaditosBinConfig') || 'null');
                return { ...BIN_DEFAULTS, ...(saved || {}) };
            } catch (e) {
                return { ...BIN_DEFAULTS };
            }
        }

        function setBinConfig(cfg) {
            localStorage.setItem('asaditosBinConfig', JSON.stringify({
                binId: (cfg.binId || '').trim(),
                header: (cfg.header || 'X-Access-Key').trim(),
                key: (cfg.key || '').trim()
            }));
        }

        function isBinConfigured() {
            const cfg = getBinConfig();
            return !!(cfg.binId && cfg.key);
        }

        function openBinSettings() {
            const cfg = getBinConfig();

            const binId = prompt('BIN ID (JSONBin) (ej: 69586b5c43b1c97be9155d82):', cfg.binId || '');
            if (binId === null) return;

            const tipo = prompt('Tipo de key: access o master (access recomendado):', (cfg.header === 'X-Master-Key') ? 'master' : 'access');
            if (tipo === null) return;

            const header = (String(tipo).trim().toLowerCase() === 'master') ? 'X-Master-Key' : 'X-Access-Key';

            const key = prompt('API Key (Access/Master). Se guarda SOLO en este dispositivo:', cfg.key || '');
            if (key === null) return;

            setBinConfig({ binId, header, key });

            if (isBinConfigured()) {
                updateSyncStatus('üîí BIN configurado - sincronizando‚Ä¶', true);
                loadFromBIN().then(() => syncToBIN({ force: true }));
            } else {
                updateSyncStatus('‚öôÔ∏è Configuraci√≥n BIN incompleta', false);
            }
        }

        // FIX: asegurar click/touch en m√≥viles
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('binConfigBtn');
            if (btn) {
                btn.addEventListener('touchend', (e) => { e.preventDefault(); openBinSettings(); }, { passive: false });
            }
        });


        let syncInterval = null;
        let isOnline = navigator.onLine;
        let lastSyncTime = null;

        // Detectar conexi√≥n online/offline
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('‚úÖ Conexi√≥n restaurada');
            // Al volver online: traer lo √∫ltimo y luego intentar subir lo local si hace falta
            if (isBinConfigured()) {
                loadFromBIN().then(() => syncToBIN());
            }
        });

window.addEventListener('offline', () => {
            isOnline = false;
            console.log('üì¥ Sin conexi√≥n - guardando local');
        });

        
        // Sincronizar con BIN (JSONBin)
        let binDirty = false;

        function getDeviceId() {
            let id = localStorage.getItem('asaditosDeviceId');
            if (!id) {
                id = 'dev_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
                localStorage.setItem('asaditosDeviceId', id);
            }
            return id;
        }

        async function syncToBIN({ force = false } = {}) {
            const cfg = getBinConfig();
            if (!isBinConfigured()) {
                updateSyncStatus('‚öôÔ∏è Configurar BIN', false);
                return;
            }

            if (!isOnline) {
                console.log('‚ö†Ô∏è Sin conexi√≥n, guardado local');
                updateSyncStatus('üì¥ Sin conexi√≥n (local)', false);
                return;
            }

            if (!binDirty && !force) {
                // Nada para subir
                updateSyncStatus('‚úÖ Sincronizado', true);
                return;
            }

            try {
                console.log('üîÑ Sincronizando con BIN...');

                // Armar payload con meta (no rompe nada si es extra)
                const payload = JSON.parse(JSON.stringify(DB));
                payload._meta = payload._meta || {};
                payload._meta.updatedAt = new Date().toISOString();
                payload._meta.deviceId = getDeviceId();

                const headers = {
                    'Content-Type': 'application/json'
                };
                headers[cfg.header] = cfg.key;

                const response = await fetch(`https://api.jsonbin.io/v3/b/${encodeURIComponent(cfg.binId)}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    lastSyncTime = new Date();
                    binDirty = false;
                    updateSyncStatus('‚úÖ Sincronizado (BIN)', true);
                    console.log('‚úÖ Sincronizado con BIN');
                } else {
                    let errMsg = 'Error al sincronizar';
                    try {
                        const err = await response.json();
                        errMsg = err.message || err.error || errMsg;
                    } catch {}
                    console.error('‚ùå BIN Error:', errMsg);
                    updateSyncStatus('‚ùå BIN: ' + errMsg, false);
                }
            } catch (error) {
                console.error('‚ùå Error de sincronizaci√≥n BIN:', error);
                updateSyncStatus('‚ö†Ô∏è Error BIN / Sin conexi√≥n', false);
            }
        }

        async function loadFromBIN() {
            const cfg = getBinConfig();
            if (!isBinConfigured()) {
                updateSyncStatus('‚öôÔ∏è Configurar BIN', false);
                return;
            }

            if (!isOnline) {
                console.log('üì¥ Sin conexi√≥n, usando datos locales');
                updateSyncStatus('üì¥ Sin conexi√≥n (local)', false);
                return;
            }

            try {
                console.log('üì• Cargando desde BIN...');
                const headers = {};
                headers[cfg.header] = cfg.key;

                const response = await fetch(`https://api.jsonbin.io/v3/b/${encodeURIComponent(cfg.binId)}/latest`, {
                    headers
                });

                if (response.ok) {
                    const data = await response.json();
                    const remote = data && data.record ? data.record : null;

                    if (!remote) {
                        updateSyncStatus('‚ÑπÔ∏è BIN vac√≠o', false);
                        return;
                    }

                    // Solo aplicar si remoto es m√°s nuevo
                    const remoteTs = remote._meta && remote._meta.updatedAt ? Date.parse(remote._meta.updatedAt) : 0;
                    const localTs = DB._meta && DB._meta.updatedAt ? Date.parse(DB._meta.updatedAt) : 0;

                    const different = JSON.stringify(DB) !== JSON.stringify(remote);

                    if (different && (remoteTs >= localTs)) {
                        // Reemplazar DB con remoto
                        DB.clientes = remote.clientes || [];
                        DB.ventas = remote.ventas || [];
                        DB.productos = remote.productos || [];
                        DB.cierres = remote.cierres || [];
                        DB.gastos = remote.gastos || [];
                        DB.mesas = remote.mesas || {};
                        DB.config = remote.config || DB.config || { sencilloDia: 0, mesasCount: 12 };
                        DB._meta = remote._meta || DB._meta || { updatedAt: 0 };

                        // Guardar local sin marcar dirty
                        saveDataLocal(false);

                        // Re-renderizar todo
                        renderProductos();
                        renderClientes();
                        renderClientesSelect();
                        renderHistorial();
                        renderListaProductos();
                        updateStats();
            renderSencilloDia();
            renderGastos();
            calcularCierre();

            ensureMesasDefaults();
            renderMesaSelect();
            renderMesasTab();
            onMesaSelectChange();

                        updateSyncStatus('‚úÖ Actualizado (BIN)', true);
                        console.log('‚úÖ Datos actualizados desde BIN');
                    } else {
                        updateSyncStatus('‚úÖ Sincronizado (BIN)', true);
                    }
                } else {
                    let errMsg = 'No se pudo leer BIN';
                    try {
                        const err = await response.json();
                        errMsg = err.message || err.error || errMsg;
                    } catch {}
                    console.error('‚ùå BIN Load Error:', errMsg);
                    updateSyncStatus('‚ùå BIN: ' + errMsg, false);
                }
            } catch (error) {
                console.error('‚ùå Error cargando desde BIN:', error);
                updateSyncStatus('‚ö†Ô∏è Error BIN / Sin conexi√≥n', false);
            }
        }


        function updateSyncStatus(message, isSuccess) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.color = isSuccess ? '#10b981' : '#ef4444';
            }
        }

        function startAutoSync() {
    // Cargar desde BIN cada 30 segundos (si est√° configurado)
    syncInterval = setInterval(() => {
        if (isOnline && isBinConfigured()) {
            loadFromBIN();
            // si hubo cambios locales pendientes, intentar subir
            syncToBIN();
        }
    }, 30000);
}


        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
        }

        let carritoVenta = {};
        let clienteSeleccionado = null;

        let mesaActiva = null; // si no es null, estamos editando/cobrando esa mesa

        function ensureMesasDefaults() {
            if (!DB.config) DB.config = { sencilloDia: 0, mesasCount: 12 };
            if (!Number.isFinite(DB.config.mesasCount) || DB.config.mesasCount < 1) DB.config.mesasCount = 12;
            if (!DB.mesas || typeof DB.mesas !== 'object') DB.mesas = {};
        }

        function mesaLabel(id) { return `Mesa ${id}`; }

        function mesaTotalProductos(productosObj) {
            return Object.keys(productosObj || {}).reduce((sum, pid) => {
                const prod = DB.productos.find(p => String(p.id) === String(pid));
                const qty = productosObj[pid] || 0;
                const precio = prod ? prod.precio : 0;
                return sum + (precio * qty);
            }, 0);
        }

        function getTabButton(tabName) {
            return Array.from(document.querySelectorAll('.tabs .tab')).find(b => (b.getAttribute('onclick') || '').includes(`'${tabName}'`)) || null;
        }

        function renderMesaSelect() {
            const sel = document.getElementById('mesaSelect');
            if (!sel) return;
            ensureMesasDefaults();
            const current = sel.value;
            let opts = `<option value="">Sin mesa (cobro directo)</option>`;
            for (let i = 1; i <= DB.config.mesasCount; i++) {
                opts += `<option value="${i}">${mesaLabel(i)}</option>`;
            }
            sel.innerHTML = opts;

            if (mesaActiva) {
                sel.value = String(mesaActiva);
                sel.disabled = true;
            } else {
                sel.disabled = false;
                sel.value = current ? current : '';
            }

            onMesaSelectChange();
        }

        function renderMesaActivaBar() {
            const bar = document.getElementById('mesaActivaBar');
            if (!bar) return;

            if (!mesaActiva) {
                bar.style.display = 'none';
                bar.innerHTML = '';
                return;
            }

            const mesa = DB.mesas[String(mesaActiva)] || { productos: {} };
            const total = mesaTotalProductos(mesa.productos || {});
            const cliente = (mesa.clienteNombre || (clienteSeleccionado ? clienteSeleccionado.nombre : '‚Äî'));

            bar.style.display = 'flex';
            bar.innerHTML = `
                <div class="left">
                    <div class="title">ü™ë ${mesaLabel(mesaActiva)} en edici√≥n</div>
                    <div class="subtitle">Pendiente: ${formatMoney(total)} ‚Ä¢ Cliente: ${cliente}</div>
                </div>
                <div class="right">
                    <button class="btn btn-secondary" type="button" onclick="guardarMesaActual()">üíæ Guardar</button>
                    <button class="btn btn-secondary" type="button" onclick="salirDeMesa()">‚Ü©Ô∏è Salir</button>
                    <button class="btn btn-danger" type="button" onclick="liberarMesaActual()">üóëÔ∏è Liberar</button>
                </div>
            `;
        }

        function onMesaSelectChange() {
            const sel = document.getElementById('mesaSelect');
            const btn = document.getElementById('guardarMesaBtn');
            const regBtn = document.getElementById('registrarVentaBtn');

            if (!sel || !btn) return;

            if (mesaActiva) {
                btn.disabled = false;
                btn.textContent = `üíæ Guardar ${mesaLabel(mesaActiva)}`;
                if (regBtn) regBtn.textContent = `‚úÖ Cobrar ${mesaLabel(mesaActiva)}`;
            } else {
                const hasMesa = sel.value !== '';
                btn.disabled = !hasMesa;
                btn.textContent = 'ü™ë Guardar en Mesa';
                if (regBtn) regBtn.textContent = '‚úÖ Registrar Venta';
            }

            renderMesaActivaBar();
        }

        function aplicarMesasCount() {
            const input = document.getElementById('mesasCount');
            if (!input) return;
            let n = parseInt(input.value || '12', 10);
            if (!Number.isFinite(n) || n < 1) n = 12;
            if (n > 50) n = 50;
            ensureMesasDefaults();
            DB.config.mesasCount = n;
            saveData();
            renderMesaSelect();
            renderMesasTab();
            alert('‚úÖ Cantidad de mesas actualizada');
        }

        function renderMesasTab() {
            const grid = document.getElementById('mesasGrid');
            const input = document.getElementById('mesasCount');
            if (!grid) return;

            ensureMesasDefaults();
            if (input) input.value = DB.config.mesasCount;

            let htmlCards = '';
            for (let i = 1; i <= DB.config.mesasCount; i++) {
                const mesa = DB.mesas[String(i)];
                const ocupada = mesa && mesa.productos && Object.keys(mesa.productos).length > 0;
                const total = ocupada ? mesaTotalProductos(mesa.productos) : 0;
                const cliente = ocupada ? (mesa.clienteNombre || '‚Äî') : '';
                htmlCards += `
                    <div class="mesa-card" onclick="abrirMesa(${i})">
                        <div class="mesa-top">
                            <div class="mesa-name">ü™ë ${mesaLabel(i)}</div>
                            <div class="mesa-badge ${ocupada ? 'ocupada' : 'libre'}">${ocupada ? 'Ocupada' : 'Libre'}</div>
                        </div>
                        <div class="mesa-total">${ocupada ? formatMoney(total) : '0 Gs'}</div>
                        <div class="mesa-info">${ocupada ? ('Cliente: ' + cliente) : 'Toque para iniciar pedido'}</div>
                    </div>
                `;
            }
            grid.innerHTML = htmlCards;
        }

        function abrirMesa(id) {
            ensureMesasDefaults();
            mesaActiva = String(id);

            const mesa = DB.mesas[mesaActiva] || { productos: {}, clienteId: null, clienteNombre: 'OCASIONAL', creado: new Date().toISOString() };

            carritoVenta = { ...(mesa.productos || {}) };

            // Cliente
            let c = null;
            if (mesa.clienteId != null) {
                c = DB.clientes.find(x => String(x.id) === String(mesa.clienteId)) || null;
            }
            if (!c) c = DB.clientes.find(x => (x.nombre || '').toUpperCase() === 'OCASIONAL') || null;
            clienteSeleccionado = c;

            // Ir a venta
            const btnVenta = getTabButton('nueva-venta');
            if (btnVenta) switchTab('nueva-venta', btnVenta);

            renderClientesSelect();
            renderProductos();
            renderMesaSelect();
            onMesaSelectChange();

            alert(`ü™ë ${mesaLabel(id)} abierta. Agreg√° productos y luego cobrala.`);
        }

        function guardarMesaActual() {
            if (!mesaActiva) return;
            if (!clienteSeleccionado) {
                alert('‚ö†Ô∏è Selecciona un cliente primero');
                return;
            }
            DB.mesas[mesaActiva] = {
                mesaId: mesaActiva,
                clienteId: clienteSeleccionado.id,
                clienteNombre: clienteSeleccionado.nombre,
                productos: { ...carritoVenta },
                creado: DB.mesas[mesaActiva]?.creado || new Date().toISOString(),
                actualizado: new Date().toISOString()
            };
            saveData();
            renderMesasTab();
            renderMesaActivaBar();
            alert('‚úÖ Mesa guardada (pendiente)');
        }

        function guardarEnMesa() {
            const sel = document.getElementById('mesaSelect');
            if (!sel) return;
            const mesaId = sel.value;

            if (!mesaId) {
                alert('‚ö†Ô∏è Eleg√≠ una mesa');
                return;
            }
            if (!clienteSeleccionado) {
                alert('‚ö†Ô∏è Selecciona un cliente primero');
                return;
            }
            if (Object.keys(carritoVenta).length === 0) {
                alert('‚ö†Ô∏è Agrega al menos un producto');
                return;
            }

            ensureMesasDefaults();
            const key = String(mesaId);
            const existing = DB.mesas[key] || { productos: {} };

            const existingCliente = existing.clienteNombre || '';
            if (existing.productos && Object.keys(existing.productos).length > 0) {
                if (existingCliente && existingCliente !== clienteSeleccionado.nombre) {
                    const ok = confirm(`La ${mesaLabel(key)} ya tiene cliente "${existingCliente}". ¬øCambiar a "${clienteSeleccionado.nombre}"?`);
                    if (ok) {
                        existing.clienteId = clienteSeleccionado.id;
                        existing.clienteNombre = clienteSeleccionado.nombre;
                    }
                }
            } else {
                existing.clienteId = clienteSeleccionado.id;
                existing.clienteNombre = clienteSeleccionado.nombre;
            }

            const merged = { ...(existing.productos || {}) };
            Object.keys(carritoVenta).forEach(pid => {
                merged[pid] = (merged[pid] || 0) + (carritoVenta[pid] || 0);
            });

            DB.mesas[key] = {
                mesaId: key,
                clienteId: existing.clienteId,
                clienteNombre: existing.clienteNombre,
                productos: merged,
                creado: existing.creado || new Date().toISOString(),
                actualizado: new Date().toISOString()
            };

            saveData();

            // Limpiar carrito (queda pendiente)
            carritoVenta = {};
            renderProductos();
            renderMesasTab();
            updateStats();
            calcularCierre();

            alert(`‚úÖ Guardado en ${mesaLabel(key)} (pendiente)`);
        }

        function liberarMesaActual() {
            if (!mesaActiva) return;
            const ok = confirm(`¬øSeguro quer√©s liberar ${mesaLabel(mesaActiva)}? Se pierde el pedido pendiente.`);
            if (!ok) return;

            delete DB.mesas[mesaActiva];
            mesaActiva = null;
            carritoVenta = {};

            saveData();

            renderMesaSelect();
            renderMesasTab();
            renderProductos();
            onMesaSelectChange();

            alert('‚úÖ Mesa liberada');
        }

        function salirDeMesa() {
            mesaActiva = null;
            carritoVenta = {};
            renderMesaSelect();
            renderProductos();
            onMesaSelectChange();
        }


        // Clientes iniciales
function loadInitialClients() {
    if (DB.clientes.length === 0) {
        DB.clientes = [
            { id: 1, nombre: 'OCASIONAL', telefono: '', deuda: 0, creado: new Date().toISOString() },
            { id: 2, nombre: 'PEDIDOS YA', telefono: '', deuda: 0, creado: new Date().toISOString() }
        ];
        saveDataLocal();
    } else {
        // Asegurar que existan OCASIONAL y PEDIDOS YA
        const names = DB.clientes.map(c => (c.nombre || '').toUpperCase());
        if (!names.includes('OCASIONAL')) {
            DB.clientes.unshift({ id: Date.now() + 1, nombre: 'OCASIONAL', telefono: '', deuda: 0, creado: new Date().toISOString() });
        }
        if (!names.includes('PEDIDOS YA')) {
            DB.clientes.push({ id: Date.now() + 2, nombre: 'PEDIDOS YA', telefono: '', deuda: 0, creado: new Date().toISOString() });
        }
        saveDataLocal();
    }
}

// Productos iniciales
        function loadInitialProducts() {
            if (DB.productos.length === 0) {
                DB.productos = [
                    { id: 1, nombre: 'ASADITO CARNE', precio: 5000 },
                    { id: 2, nombre: 'ASADITO POLLO', precio: 5000 },
                    { id: 3, nombre: 'ASADITO CERDO', precio: 5000 },
                    { id: 4, nombre: 'CHORIQUESO', precio: 6000 },
                    { id: 5, nombre: 'PICANTE BESITO', precio: 5000 },
                    { id: 6, nombre: 'ALITA DE POLLO', precio: 5000 },
                    { id: 7, nombre: 'PARRILLERO', precio: 5000 },
                    { id: 8, nombre: 'BUTIFARRA', precio: 5000 },
                    { id: 9, nombre: 'MORCILLA OSCHI', precio: 5000 },
                    { id: 10, nombre: 'CHINCHULIN', precio: 5000 },
                    { id: 11, nombre: 'COCA 250ml', precio: 4000 },
                    { id: 12, nombre: 'COCA 1L DES', precio: 10000 },
                    { id: 13, nombre: 'COCA 2L RET', precio: 12000 },
                    { id: 14, nombre: 'MUSLO DE POLLO', precio: 15000 },
                    { id: 15, nombre: 'COCA 1L RET', precio: 8000 },
                    { id: 16, nombre: 'COCA ZERO 500', precio: 8000 },
                    { id: 17, nombre: 'FANTA NARANJA 500', precio: 8000 },
                    { id: 18, nombre: 'OURO LITRO', precio: 10000 },
                    { id: 19, nombre: 'Pulp 250', precio: 4000 }
                ];
                saveData();
            }
        }

        // Cierre de Caja
        function calcularCierre() {
            const billetes = {
                100000: parseInt(document.getElementById('billete100000').value) || 0,
                50000: parseInt(document.getElementById('billete50000').value) || 0,
                20000: parseInt(document.getElementById('billete20000').value) || 0,
                10000: parseInt(document.getElementById('billete10000').value) || 0,
                5000: parseInt(document.getElementById('billete5000').value) || 0,
                2000: parseInt(document.getElementById('billete2000').value) || 0
            };

            const monedas = {
                1000: parseInt(document.getElementById('moneda1000').value) || 0,
                500: parseInt(document.getElementById('moneda500').value) || 0,
                100: parseInt(document.getElementById('moneda100').value) || 0,
                50: parseInt(document.getElementById('moneda50').value) || 0
            };

            // Actualizar totales individuales
            Object.keys(billetes).forEach(valor => {
                const total = billetes[valor] * parseInt(valor);
                document.getElementById(`total${valor}`).textContent = formatMoney(total);
            });

            Object.keys(monedas).forEach(valor => {
                const total = monedas[valor] * parseInt(valor);
                document.getElementById(`total${valor}`).textContent = formatMoney(total);
            });

            // Total efectivo contado
            const totalBilletes = Object.keys(billetes).reduce((sum, valor) => sum + (billetes[valor] * parseInt(valor)), 0);
            const totalMonedas = Object.keys(monedas).reduce((sum, valor) => sum + (monedas[valor] * parseInt(valor)), 0);
            const totalEfectivoContado = totalBilletes + totalMonedas;

            document.getElementById('totalEfectivoContado').textContent = formatMoney(totalEfectivoContado);

            // Calcular ventas del d√≠a por m√©todo de pago
            const hoy = new Date().toDateString();
            const ventasHoy = DB.ventas.filter(v => new Date(v.fecha).toDateString() === hoy);

            const efectivoSistema = ventasHoy.filter(v => v.metodoPago === 'efectivo').reduce((sum, v) => sum + v.total, 0);
            const transferencias = ventasHoy.filter(v => v.metodoPago === 'transferencia').reduce((sum, v) => sum + v.total, 0);
            const tarjetasDebito = ventasHoy.filter(v => v.metodoPago === 'tarjeta-debito').reduce((sum, v) => sum + v.total, 0);
            const tarjetasCredito = ventasHoy.filter(v => v.metodoPago === 'tarjeta-credito').reduce((sum, v) => sum + v.total, 0);
            const credito = ventasHoy.filter(v => v.metodoPago === 'credito').reduce((sum, v) => sum + v.total, 0);
            const fiado = ventasHoy.filter(v => v.metodoPago === 'deuda').reduce((sum, v) => sum + v.total, 0);

            const totalTarjetas = tarjetasDebito + tarjetasCredito;
            const totalDia = efectivoSistema + transferencias + totalTarjetas + credito + fiado;

            document.getElementById('efectivoSistema').textContent = formatMoney(efectivoSistema);
            document.getElementById('transferencias').textContent = formatMoney(transferencias);
            document.getElementById('tarjetas').textContent = formatMoney(totalTarjetas);
            document.getElementById('credito').textContent = formatMoney(credito);
            document.getElementById('fiado').textContent = formatMoney(fiado);
            document.getElementById('totalDia').textContent = formatMoney(totalDia);

            // Sencillo y gastos (hoy)
            const sencilloDia = parseInt((DB.config && DB.config.sencilloDia) ? DB.config.sencilloDia : 0) || 0;
            const gastosHoy = (DB.gastos || []).filter(g => new Date(g.fecha).toDateString() === hoy);
            const gastosEfectivoHoy = gastosHoy
                .filter(g => (g.metodo || 'efectivo') === 'efectivo')
                .reduce((sum, g) => sum + (parseInt(g.monto) || 0), 0);

            const efectivoEsperado = sencilloDia + efectivoSistema - gastosEfectivoHoy;

            const sEl = document.getElementById('sencilloDiaResumen');
            if (sEl) sEl.textContent = formatMoney(sencilloDia);

            const gEl = document.getElementById('gastosEfectivoResumen');
            if (gEl) gEl.textContent = formatMoney(gastosEfectivoHoy);

            const eEl = document.getElementById('efectivoEsperadoResumen');
            if (eEl) eEl.textContent = formatMoney(efectivoEsperado);

            const tgEl = document.getElementById('totalGastosEfectivoHoy');
            if (tgEl) tgEl.textContent = formatMoney(gastosEfectivoHoy);


            // Calcular descuadre
            const descuadre = totalEfectivoContado - efectivoEsperado;
            const descuadreCard = document.getElementById('descuadreCard');
            const descuadreEl = document.getElementById('descuadre');
            const descuadreMensaje = document.getElementById('descuadreMensaje');

            descuadreEl.textContent = formatMoney(Math.abs(descuadre));

            if (descuadre === 0) {
                descuadreCard.style.background = '#d1fae5';
                descuadreCard.style.color = '#065f46';
                descuadreMensaje.textContent = '‚úÖ Caja cuadrada';
            } else if (descuadre > 0) {
                descuadreCard.style.background = '#dbeafe';
                descuadreCard.style.color = '#1e40af';
                descuadreMensaje.textContent = 'üìà Sobra efectivo';
            } else {
                descuadreCard.style.background = '#fee2e2';
                descuadreCard.style.color = '#991b1b';
                descuadreMensaje.textContent = 'üìâ Falta efectivo';
            }
        }

        
        // ===== SENCILLO & GASTOS =====
        function ensureConfigDefaults() {
            DB.config = DB.config || { sencilloDia: 0 };
            if (typeof DB.config.sencilloDia !== 'number') {
                DB.config.sencilloDia = parseInt(DB.config.sencilloDia) || 0;
            }
            DB.gastos = DB.gastos || [];
        }

        function renderSencilloDia() {
            ensureConfigDefaults();
            const input = document.getElementById('sencilloDiaInput');
            if (input) {
                input.value = DB.config.sencilloDia || 0;
            }
        }

        function guardarSencilloDia() {
            ensureConfigDefaults();
            const input = document.getElementById('sencilloDiaInput');
            if (!input) return;

            const val = parseInt((input.value || '').trim()) || 0;
            DB.config.sencilloDia = val;

            saveData();
            calcularCierre();
            alert('‚úÖ Sencillo del d√≠a guardado');
        }

        function agregarGasto() {
            ensureConfigDefaults();
            const descEl = document.getElementById('gastoDesc');
            const montoEl = document.getElementById('gastoMonto');
            const metodoEl = document.getElementById('gastoMetodo');

            const descripcion = (descEl?.value || '').trim();
            const monto = parseInt((montoEl?.value || '').trim()) || 0;
            const metodo = (metodoEl?.value || 'efectivo').trim();

            if (!descripcion) {
                alert('‚ö†Ô∏è Escribe una descripci√≥n del gasto');
                return;
            }
            if (monto <= 0) {
                alert('‚ö†Ô∏è Ingresa un monto v√°lido');
                return;
            }

            DB.gastos.push({
                id: Date.now(),
                descripcion,
                monto,
                metodo,
                fecha: new Date().toISOString()
            });

            if (descEl) descEl.value = '';
            if (montoEl) montoEl.value = '';
            if (metodoEl) metodoEl.value = 'efectivo';

            saveData();
            renderGastos();
            calcularCierre();
        }

        function eliminarGasto(id) {
            ensureConfigDefaults();
            const ok = confirm('¬øEliminar este gasto?');
            if (!ok) return;

            DB.gastos = (DB.gastos || []).filter(g => g.id !== id);
            saveData();
            renderGastos();
            calcularCierre();
        }

        function renderGastos() {
            ensureConfigDefaults();
            const cont = document.getElementById('gastosHoyLista');
            if (!cont) return;

            const hoyStr = new Date().toDateString();
            const gastosHoy = (DB.gastos || [])
                .filter(g => new Date(g.fecha).toDateString() === hoyStr)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            if (gastosHoy.length === 0) {
                cont.innerHTML = '<div class="empty-state">üßæ No hay gastos cargados hoy</div>';
            } else {
                cont.innerHTML = gastosHoy.map(g => {
                    const fecha = new Date(g.fecha);
                    const hora = fecha.toLocaleTimeString('es-PY', { hour: '2-digit', minute: '2-digit' });
                    const metodo = (g.metodo || 'efectivo');
                    const badge = metodo === 'efectivo' ? 'üíµ' : metodo === 'transferencia' ? 'üè¶' : 'üí≥';

                    return `
                        <div style="display:flex; justify-content: space-between; align-items:center; gap: 10px; padding: 12px; background:#ffffff; border:1px solid #e5e7eb; border-radius: 10px; margin-bottom: 10px;">
                            <div style="min-width:0;">
                                <div style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${badge} ${g.descripcion}</div>
                                <div style="font-size:12px; opacity:0.75;">${hora} ‚Ä¢ ${metodo.toUpperCase()}</div>
                            </div>
                            <div style="display:flex; align-items:center; gap: 10px;">
                                <div style="font-weight:900; color:#ef4444;">-${formatMoney(g.monto)}</div>
                                <button class="btn-danger" onclick="eliminarGasto(${g.id})">üóë</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }


        function guardarCierre() {
            const hoy = new Date().toISOString().split('T')[0];
            const totalEfectivoContado = parseInt(document.getElementById('totalEfectivoContado').textContent.replace(/[^\d]/g, ''));

            const hoyStr = new Date().toDateString();
            const ventasHoy = DB.ventas.filter(v => new Date(v.fecha).toDateString() === hoyStr);
            const efectivoSistema = ventasHoy.filter(v => v.metodoPago === 'efectivo').reduce((sum, v) => sum + v.total, 0);

            const sencilloDia = parseInt((DB.config && DB.config.sencilloDia) ? DB.config.sencilloDia : 0) || 0;
            const gastosHoy = (DB.gastos || []).filter(g => new Date(g.fecha).toDateString() === hoyStr);
            const gastosEfectivoHoy = gastosHoy
                .filter(g => (g.metodo || 'efectivo') === 'efectivo')
                .reduce((sum, g) => sum + (parseInt(g.monto) || 0), 0);

            const efectivoEsperado = sencilloDia + efectivoSistema - gastosEfectivoHoy;
            const descuadre = totalEfectivoContado - efectivoEsperado;

            const cierre = {
                fecha: hoy,
                efectivoContado: totalEfectivoContado,
                efectivoSistema: efectivoSistema,
                                sencilloDia: sencilloDia,
                gastosEfectivoHoy: gastosEfectivoHoy,
                efectivoEsperado: efectivoEsperado,
transferencias: parseInt(document.getElementById('transferencias').textContent.replace(/[^\d]/g, '')),
                tarjetas: parseInt(document.getElementById('tarjetas').textContent.replace(/[^\d]/g, '')),
                credito: parseInt(document.getElementById('credito').textContent.replace(/[^\d]/g, '')),
                fiado: parseInt(document.getElementById('fiado').textContent.replace(/[^\d]/g, '')),
                totalDia: parseInt(document.getElementById('totalDia').textContent.replace(/[^\d]/g, '')),
                descuadre: descuadre
            };

            if (!DB.cierres) DB.cierres = [];
            DB.cierres.push(cierre);
            saveData();

            alert(`‚úÖ Cierre guardado exitosamente!\n\nTotal del d√≠a: ${formatMoney(cierre.totalDia)}\nDescuadre: ${formatMoney(Math.abs(descuadre))}\n${descuadre === 0 ? '‚úÖ Caja cuadrada' : descuadre > 0 ? 'üìà Sobra' : 'üìâ Falta'}`);

            // Limpiar campos
            ['billete100000', 'billete50000', 'billete20000', 'billete10000', 'billete5000', 'billete2000',
             'moneda1000', 'moneda500', 'moneda100', 'moneda50'].forEach(id => {
                document.getElementById(id).value = 0;
            });
            calcularCierre();
        }

        // Inicializar
        function init() {
            loadData();
            loadInitialProducts();
            loadInitialClients();
            updateDate();
            renderProductos();
            renderClientes();
            renderClientesSelect();
            renderHistorial();
            renderListaProductos();
                        updateStats();
                        renderSencilloDia();
                        renderGastos();
                        calcularCierre();
            ensureMesasDefaults();
            renderMesaSelect();
            renderMesasTab();
            onMesaSelectChange();
            toggleVueltoCalculator();
            
            // Iniciar sincronizaci√≥n autom√°tica
            if (isBinConfigured()) {
                loadFromBIN().then(() => startAutoSync());
            } else {
                updateSyncStatus('‚öôÔ∏è Configurar BIN', false);
                startAutoSync();
            }
}

        function updateDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('es-PY', options);
        }

        // Tabs
        function switchTab(tabName, el) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            (el || event.target).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Renderizar productos
        function renderProductos() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = DB.productos.map(p => `
                <div class="product-card ${carritoVenta[p.id] ? 'selected' : ''}" onclick="toggleProducto(${p.id})">
                    <div class="product-name">${p.nombre}</div>
                    <div class="product-price">${formatMoney(p.precio)}</div>
                    ${carritoVenta[p.id] ? `
                        <div class="quantity-control" onclick="event.stopPropagation()">
                            <button class="quantity-btn" onclick="cambiarCantidad(${p.id}, -1)">-</button>
                            <div class="quantity">${carritoVenta[p.id]}</div>
                            <button class="quantity-btn" onclick="cambiarCantidad(${p.id}, 1)">+</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            calcularTotal();
        }

        function toggleProducto(id) {
            if (carritoVenta[id]) {
                delete carritoVenta[id];
            } else {
                carritoVenta[id] = 1;
            }
            renderProductos();
        }

        function cambiarCantidad(id, delta) {
            carritoVenta[id] = Math.max(0, (carritoVenta[id] || 0) + delta);
            if (carritoVenta[id] === 0) delete carritoVenta[id];
            renderProductos();
        }

        function calcularTotal() {
            const total = Object.keys(carritoVenta).reduce((sum, id) => {
                const producto = DB.productos.find(p => p.id == id);
                return sum + (producto.precio * carritoVenta[id]);
            }, 0);
            document.getElementById('totalVenta').textContent = `Total: ${formatMoney(total)}`;
            
            // Mostrar detalle del carrito
            const carritoDetalle = document.getElementById('carritoDetalle');
            const listaCarrito = document.getElementById('listaCarrito');
            
            if (Object.keys(carritoVenta).length > 0) {
                carritoDetalle.style.display = 'block';
                
                listaCarrito.innerHTML = Object.keys(carritoVenta).map(id => {
                    const producto = DB.productos.find(p => p.id == id);
                    const cantidad = carritoVenta[id];
                    const subtotal = producto.precio * cantidad;
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
                            <div>
                                <div style="font-weight: 700; color: #1f2937;">${producto.nombre}</div>
                                <div style="font-size: 14px; color: #6b7280;">${formatMoney(producto.precio)} √ó ${cantidad}</div>
                            </div>
                            <div style="font-weight: 700; color: #10b981; font-size: 16px;">${formatMoney(subtotal)}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('subtotalCarrito').textContent = formatMoney(total);
            } else {
                carritoDetalle.style.display = 'none';
            }
            
            // Recalcular vuelto si est√° visible
            calcularVuelto();
        }

        function toggleVueltoCalculator() {
            const metodoPago = document.getElementById('metodoPago').value;

            // Monto pagado en efectivo es opcional
            let montoPagado = null;
            let vuelto = null;
            if (metodoPago === 'efectivo') {
                const raw = (document.getElementById('montoPagado')?.value || '').trim();
                if (raw !== '') {
                    montoPagado = parseInt(raw) || 0;
                    vuelto = montoPagado - total;
                }
            }
            const vueltoCalc = document.getElementById('vueltoCalculator');
            
            if (metodoPago === 'efectivo') {
                vueltoCalc.style.display = 'block';
            } else {
                vueltoCalc.style.display = 'none';
                document.getElementById('montoPagado').value = '';
                document.getElementById('vueltoTotal').textContent = '0 Gs';
            }
        }

        function calcularVuelto() {
            const total = Object.keys(carritoVenta).reduce((sum, id) => {
                const producto = DB.productos.find(p => p.id == id);
                return sum + (producto.precio * carritoVenta[id]);
            }, 0);

            const inputEl = document.getElementById('montoPagado');
            const vueltoEl = document.getElementById('vueltoTotal');
            if (!inputEl || !vueltoEl) return;

            const raw = (inputEl.value || '').trim();

            // Si no se ingres√≥ nada, el vuelto es opcional (no bloquear la venta)
            if (raw === '') {
                vueltoEl.textContent = '‚Äî';
                vueltoEl.style.color = 'white';
                return;
            }

            const montoPagado = parseInt(raw) || 0;
            const vuelto = montoPagado - total;

            if (vuelto >= 0) {
                vueltoEl.textContent = formatMoney(vuelto);
                vueltoEl.style.color = 'white';
            } else {
                // Mostrar falta, pero NO bloquear el cobro
                vueltoEl.textContent = 'Falta: ' + formatMoney(Math.abs(vuelto));
                vueltoEl.style.color = '#fecaca';
            }
        }

        // Clientes
        function agregarCliente() {
            const nombre = document.getElementById('clienteNombre').value.trim();
            if (!nombre) {
                alert('Por favor ingresa un nombre');
                return;
            }

            const cliente = {
                id: Date.now(),
                nombre: nombre,
                telefono: document.getElementById('clienteTelefono').value.trim(),
                deuda: 0,
                creado: new Date().toISOString()
            };

            DB.clientes.push(cliente);
            saveData();
            
            document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteTelefono').value = '';
            
            renderClientes();
            renderClientesSelect();
            alert('‚úÖ Cliente agregado exitosamente');
        }

        function selectCliente() {
            const id = document.getElementById('clienteSelect').value;
            clienteSeleccionado = DB.clientes.find(c => c.id == id);
            
            // Auto-seleccionar m√©todo de pago seg√∫n cliente
            const metodoPagoSelect = document.getElementById('metodoPago');
            if (clienteSeleccionado && clienteSeleccionado.nombre.toLowerCase().includes('pedidos ya')) {
                metodoPagoSelect.value = 'credito';
            } else {
                metodoPagoSelect.value = 'efectivo';
            }
            
            toggleVueltoCalculator();
        }

        function renderClientes() {
            const lista = document.getElementById('listaClientes');
            document.getElementById('totalClientes').textContent = DB.clientes.length;
            
            if (DB.clientes.length === 0) {
                lista.innerHTML = '<div class="empty-state">üìã No hay clientes registrados</div>';
                return;
            }

            lista.innerHTML = DB.clientes.map(c => `
                <div class="cliente-item">
                    <div class="cliente-info">
                        <h3>${c.nombre}</h3>
                        <p>${c.telefono || 'Sin tel√©fono'}</p>
                    </div>
                    <div class="deuda ${c.deuda <= 0 ? 'positiva' : ''}">${c.deuda > 0 ? formatMoney(c.deuda) : '‚úÖ'}</div>
                </div>
            `).join('');
        }

        function renderClientesSelect() {
            const select = document.getElementById('clienteSelect');
            select.innerHTML = '<option value="">-- Seleccionar Cliente --</option>' +
                DB.clientes.map(c => `<option value="${c.id}">${c.nombre}${c.deuda > 0 ? ' (Deuda: ' + formatMoney(c.deuda) + ')' : ''}</option>`).join('');
            setDefaultClienteOcasional();
        }

        function setDefaultClienteOcasional(force = false) {
            const select = document.getElementById('clienteSelect');
            if (!select) return;

            const current = (select.value || '').toString();
            const exists = current && DB.clientes.some(c => String(c.id) === current);

            if (!force && exists) {
                // Mantener selecci√≥n actual
                if (!clienteSeleccionado) {
                    clienteSeleccionado = DB.clientes.find(c => String(c.id) === current) || null;
                }
                // Ajustar m√©todo de pago seg√∫n cliente seleccionado
                const metodoPagoSelect = document.getElementById('metodoPago');
                if (clienteSeleccionado && metodoPagoSelect) {
                    if ((clienteSeleccionado.nombre || '').toLowerCase().includes('pedidos ya')) {
                        metodoPagoSelect.value = 'credito';
                    } else {
                        metodoPagoSelect.value = 'efectivo';
                    }
                    toggleVueltoCalculator();
                }
                return;
            }

            const ocasional = DB.clientes.find(c => (c.nombre || '').toUpperCase() === 'OCASIONAL');
            if (!ocasional) return;

            select.value = String(ocasional.id);
            clienteSeleccionado = ocasional;

            const metodoPagoSelect = document.getElementById('metodoPago');
            if (metodoPagoSelect) {
                metodoPagoSelect.value = 'efectivo';
            }
            toggleVueltoCalculator();
        }

        // Ventas
        function registrarVenta() {
            if (!clienteSeleccionado) {
                alert('‚ö†Ô∏è Selecciona un cliente primero');
                return;
            }

            if (Object.keys(carritoVenta).length === 0) {
                alert('‚ö†Ô∏è Agrega al menos un producto');
                return;
            }

            const total = Object.keys(carritoVenta).reduce((sum, id) => {
                const producto = DB.productos.find(p => p.id == id);
                return sum + (producto.precio * carritoVenta[id]);
            }, 0);

            const metodoPago = document.getElementById('metodoPago').value;

            // Monto pagado y vuelto: OPCIONALES
            const rawPagado = (document.getElementById('montoPagado')?.value || '').trim();
            let montoPagado = null;
            let vuelto = null;

            if (rawPagado !== '') {
                montoPagado = parseInt(rawPagado) || 0;
                vuelto = montoPagado - total;
            }

            const venta = {
                id: Date.now(),
                clienteId: clienteSeleccionado.id,
                clienteNombre: clienteSeleccionado.nombre,
                productos: { ...carritoVenta },
                total: total,
                metodoPago: metodoPago,
                montoPagado: montoPagado,
                vuelto: vuelto,
                fecha: new Date().toISOString()
            };

            DB.ventas.push(venta);

            // Si es fiado, agregar a deuda del cliente
            if (metodoPago === 'deuda') {
                const cliente = DB.clientes.find(c => c.id === clienteSeleccionado.id);
                if (cliente) cliente.deuda += total;
            }

            // Si ven√≠amos de una mesa activa, al cobrar se libera la mesa
            if (mesaActiva) {
                delete DB.mesas[String(mesaActiva)];
                mesaActiva = null;
            }

            saveData();

            // Actualizar UI de mesas
            renderMesaSelect();
            renderMesasTab();
            onMesaSelectChange();

            // Limpiar carrito
            carritoVenta = {};

            // Limpiar monto pagado (opcional)
            const mpEl = document.getElementById('montoPagado');
            if (mpEl) mpEl.value = '';

            // Cliente por defecto: OCASIONAL
            const oc = DB.clientes.find(c => (c.nombre || '').toUpperCase() === 'OCASIONAL') || null;
            clienteSeleccionado = oc;
            const selCliente = document.getElementById('clienteSelect');
            if (selCliente) {
                selCliente.value = oc ? String(oc.id) : '';
            }

            renderProductos();
            renderClientes();
            renderClientesSelect();
            renderHistorial();
            updateStats();
            calcularCierre();

            alert(`‚úÖ Venta registrada!\n\nTotal: ${formatMoney(total)}\nCliente: ${venta.clienteNombre}\nM√©todo: ${metodoPago.toUpperCase()}`);
        }



        function renderHistorial() {
            const lista = document.getElementById('listaVentas');
            
            if (DB.ventas.length === 0) {
                lista.innerHTML = '<div class="empty-state">üìä No hay ventas registradas</div>';
                return;
            }

            const ventasOrdenadas = [...DB.ventas].reverse();
            
            lista.innerHTML = ventasOrdenadas.map(v => {
                const fecha = new Date(v.fecha);
                const productosTexto = Object.keys(v.productos).map(id => {
                    const prod = DB.productos.find(p => p.id == id);
                    return `${prod ? prod.nombre : 'Producto eliminado'} x${v.productos[id]}`;
                }).join(', ');

                return `
                    <div class="venta-item">
                        <div class="venta-header">
                            <div class="venta-cliente">${v.clienteNombre}</div>
                            <div class="venta-total">${formatMoney(v.total)}</div>
                        </div>
                        <div class="venta-fecha">${fecha.toLocaleString('es-PY')}</div>
                        <div class="venta-productos">${productosTexto}</div>
                        <div style="display: flex; gap: 8px; margin-top: 10px; align-items: center;">
                            <span class="metodo-pago metodo-${v.metodoPago}">
                                ${v.metodoPago === 'efectivo' ? 'üíµ Efectivo' : 
                                  v.metodoPago === 'transferencia' ? 'üè¶ Transferencia' : 
                                  v.metodoPago === 'tarjeta-debito' ? 'üí≥ Tarjeta D√©bito' :
                                  v.metodoPago === 'tarjeta-credito' ? 'üí≥ Tarjeta Cr√©dito' :
                                  v.metodoPago === 'credito' ? 'üí≥ Cr√©dito (Pedidos Ya)' :
                                  'üìù Fiado'}
                            </span>
                            <div style="margin-left: auto; display: flex; gap: 5px;">
                                <button onclick="editarVenta(${v.id})" style="padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">‚úèÔ∏è Editar</button>
                                <button onclick="eliminarVenta(${v.id})" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">üóëÔ∏è Borrar</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Editar y Eliminar Ventas
        function editarVenta(id) {
            const venta = DB.ventas.find(v => v.id === id);
            if (!venta) return;

            // Preguntar qu√© quiere editar
            const opcion = prompt(
                `Editar venta de ${venta.clienteNombre}\n\n` +
                `1 = Cambiar m√©todo de pago\n` +
                `2 = Cambiar total\n` +
                `3 = Cancelar\n\n` +
                `Ingresa el n√∫mero:`
            );

            if (opcion === '1') {
                const nuevoMetodo = prompt(
                    `M√©todo de pago actual: ${venta.metodoPago}\n\n` +
                    `Nuevo m√©todo de pago:\n` +
                    `1 = Cr√©dito (Pedidos Ya)\n` +
                    `2 = Efectivo\n` +
                    `3 = Transferencia\n` +
                    `4 = Tarjeta D√©bito\n` +
                    `5 = Tarjeta Cr√©dito\n` +
                    `6 = Fiado\n\n` +
                    `Ingresa el n√∫mero:`
                );

                const metodos = {
                    '1': 'credito',
                    '2': 'efectivo',
                    '3': 'transferencia',
                    '4': 'tarjeta-debito',
                    '5': 'tarjeta-credito',
                    '6': 'deuda'
                };

                if (metodos[nuevoMetodo]) {
                    // Si cambia de/a fiado, actualizar deuda del cliente
                    const cliente = DB.clientes.find(c => c.id === venta.clienteId);
                    if (cliente) {
                        if (venta.metodoPago === 'deuda') {
                            // Estaba fiado, quitar deuda
                            cliente.deuda -= venta.total;
                        }
                        if (metodos[nuevoMetodo] === 'deuda') {
                            // Ahora es fiado, agregar deuda
                            cliente.deuda += venta.total;
                        }
                    }

                    venta.metodoPago = metodos[nuevoMetodo];
                    saveData();
                    renderHistorial();
                    renderClientes();
                    updateStats();
                    calcularCierre();
                    alert('‚úÖ M√©todo de pago actualizado');
                }
            } else if (opcion === '2') {
                const nuevoTotal = parseInt(prompt(`Total actual: ${formatMoney(venta.total)}\n\nNuevo total (Gs):`, venta.total));
                
                if (nuevoTotal && nuevoTotal > 0) {
                    // Si es fiado, actualizar deuda
                    if (venta.metodoPago === 'deuda') {
                        const cliente = DB.clientes.find(c => c.id === venta.clienteId);
                        if (cliente) {
                            cliente.deuda = cliente.deuda - venta.total + nuevoTotal;
                        }
                    }

                    venta.total = nuevoTotal;
                    saveData();
                    renderHistorial();
                    renderClientes();
                    updateStats();
                    calcularCierre();
                    alert('‚úÖ Total actualizado');
                }
            }
        }

        function eliminarVenta(id) {
            const venta = DB.ventas.find(v => v.id === id);
            if (!venta) return;

            if (!confirm(`¬øEliminar esta venta?\n\nCliente: ${venta.clienteNombre}\nTotal: ${formatMoney(venta.total)}\nM√©todo: ${venta.metodoPago}`)) {
                return;
            }

            // Si era fiado, quitar deuda del cliente
            if (venta.metodoPago === 'deuda') {
                const cliente = DB.clientes.find(c => c.id === venta.clienteId);
                if (cliente) {
                    cliente.deuda -= venta.total;
                }
            }

            DB.ventas = DB.ventas.filter(v => v.id !== id);
            saveData();
            renderHistorial();
            renderClientes();
            updateStats();
            calcularCierre();
            alert('‚úÖ Venta eliminada');
        }

        function updateStats() {
            const hoy = new Date().toDateString();
            const ventasHoy = DB.ventas.filter(v => new Date(v.fecha).toDateString() === hoy);
            
            document.getElementById('totalVentasHoy').textContent = ventasHoy.length;
            
            const ingresoHoy = ventasHoy.reduce((sum, v) => {
                // Solo cuenta efectivo, transferencias y tarjetas (no cr√©dito ni deuda)
                return sum + (v.metodoPago !== 'deuda' && v.metodoPago !== 'credito' ? v.total : 0);
            }, 0);
            
            document.getElementById('ingresoHoy').textContent = formatMoney(ingresoHoy);
        }

        // Gesti√≥n de Productos
        function agregarProducto() {
            const nombre = document.getElementById('productoNombre').value.trim().toUpperCase();
            const precio = parseInt(document.getElementById('productoPrecio').value);

            if (!nombre) {
                alert('‚ö†Ô∏è Por favor ingresa un nombre');
                return;
            }

            if (!precio || precio <= 0) {
                alert('‚ö†Ô∏è Por favor ingresa un precio v√°lido');
                return;
            }

            const producto = {
                id: Date.now(),
                nombre: nombre,
                precio: precio
            };

            DB.productos.push(producto);
            saveData();

            document.getElementById('productoNombre').value = '';
            document.getElementById('productoPrecio').value = '';

            renderProductos();
            renderListaProductos();
            alert('‚úÖ Producto agregado exitosamente');
        }

        function editarProducto(id) {
            const producto = DB.productos.find(p => p.id === id);
            if (!producto) return;

            const nuevoNombre = prompt('Nuevo nombre:', producto.nombre);
            if (nuevoNombre && nuevoNombre.trim()) {
                producto.nombre = nuevoNombre.trim().toUpperCase();
            }

            const nuevoPrecio = prompt('Nuevo precio (Gs):', producto.precio);
            if (nuevoPrecio && parseInt(nuevoPrecio) > 0) {
                producto.precio = parseInt(nuevoPrecio);
            }

            saveData();
            renderProductos();
            renderListaProductos();
        }

        function eliminarProducto(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;

            DB.productos = DB.productos.filter(p => p.id !== id);
            saveData();
            renderProductos();
            renderListaProductos();
        }

        function renderListaProductos() {
            const lista = document.getElementById('listaProductos');
            document.getElementById('totalProductos').textContent = DB.productos.length;

            if (DB.productos.length === 0) {
                lista.innerHTML = '<div class="empty-state">üì¶ No hay productos registrados</div>';
                return;
            }

            lista.innerHTML = DB.productos.map(p => `
                <div class="cliente-item">
                    <div class="cliente-info">
                        <h3>${p.nombre}</h3>
                        <p style="color: #10b981; font-weight: 700;">${formatMoney(p.precio)}</p>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-secondary" style="padding: 8px 12px; border-radius: 6px; border: none; color: white; font-size: 12px;" onclick="editarProducto(${p.id})">‚úèÔ∏è</button>
                        <button class="btn-danger" style="padding: 8px 12px; border-radius: 6px; border: none; color: white; font-size: 12px;" onclick="eliminarProducto(${p.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Utilidades
        function formatMoney(amount) {
            return new Intl.NumberFormat('es-PY', {
                style: 'decimal',
                minimumFractionDigits: 0
            }).format(amount) + ' Gs';
        }

        function saveData() {
            saveDataLocal(true);
            if (isOnline && isBinConfigured()) {
                syncToBIN();
            }
        }

        function saveDataLocal(markDirty = true) {
            localStorage.setItem('ventasAsaditosDB', JSON.stringify(DB));
            if (markDirty) {
                binDirty = true;
            }
        }

        function loadData() {
            const saved = localStorage.getItem('ventasAsaditosDB');
            if (saved) {
                const loaded = JSON.parse(saved);
                DB.clientes = loaded.clientes || [];
                DB.ventas = loaded.ventas || [];
                DB.productos = loaded.productos || [];
                DB.cierres = loaded.cierres || [];
                DB.gastos = loaded.gastos || [];
                DB.config = loaded.config || DB.config || { sencilloDia: 0 };
                DB._meta = loaded._meta || DB._meta || { updatedAt: 0 };
            }
        }

        // Backup Manual
        function exportarDatos() {
            const dataStr = JSON.stringify(DB, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `asaditos-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úÖ Backup descargado exitosamente');
        }

        function importarDatos(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('‚ö†Ô∏è ¬øRestaurar backup?\n\nEsto reemplazar√° todos los datos actuales.')) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    Object.assign(DB, imported);
                    saveData();
                    
                    // Re-renderizar todo
                    renderProductos();
                    renderClientes();
                    renderClientesSelect();
                    renderHistorial();
                    renderListaProductos();
                    updateStats();
                    calcularCierre();
                    
                    alert('‚úÖ Backup restaurado exitosamente');
                } catch (error) {
                    alert('‚ùå Error al importar backup:\n' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Iniciar
        init();
    
        // --- FIX: click/touch robusto para abrir configuraci√≥n BIN ---
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('binConfigBtn');
            if (!btn) return;
            const handler = (e) => {
                try {
                    e.preventDefault();
                    e.stopPropagation();
                } catch {}
                if (typeof openBinConfig === 'function') openBinConfig();
            };
            btn.addEventListener('click', handler, { passive: false });
            btn.addEventListener('touchend', handler, { passive: false });
        });

</script>
<script>
  // PWA: Service Worker registration (caches the UI for faster loading)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.warn);
    });
  }
</script>
</body>
</html>
